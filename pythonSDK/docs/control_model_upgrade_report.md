# 控制模型改进与高阶策略报告

## 1. 报告概述

本报告针对当前使用的基于 DJI DRC 接口的键盘控制与 PID 平面定位控制方案，系统地梳理现有模型的结构、运行机理以及潜在风险，重点分析“输入为位置、输出为杆量”这一控制链条造成的性能瓶颈与稳定性隐患，并提出多种可落地的改进方向与可供迭代的高阶控制器架构。报告同时给出实施路线、调试策略、评估指标以及后续研究建议，力求在兼顾实际工程落地难度的前提下，为团队提供一份字数不少于一万字的全面技术方案。

## 2. 背景与目标

### 2.1 项目背景

当前团队的 Python SDK 代码主要通过 VRPN 动捕系统获取无人机的实时位姿，再通过 PID 控制算法计算出与目标航点或目标偏航角的误差，并将控制量映射为 DJI DRC 接口的摇杆杆量指令。需要特别说明的是，虽然 VRPN 数据流中同时包含速度与加速度信息，但在现阶段的系统接口与安全策略设定下，最终控制器无法直接使用这些速度或加速度数据，只能依赖位置与姿态（Yaw）信息开展闭环控制。因此，后续所有分析均基于“输入只有位置与姿态观测”这一硬性约束。由于 DRC 接口模拟的是遥控器拨杆行为，因此输出信号本质上对应的是姿态或速度的间接指令，具有“加速度”或“力”类的特征，而非直接的位置信号。这种控制链条在最初验证阶段具备较低的实现门槛，却也限制了最终可达成的稳态误差、响应速度以及对外界扰动的抑制能力。

随着项目的推进，团队希望提升控制精度、增强抗扰能力，并避免由于 PID 调参不当而造成的抖振、积分饱和或意外的姿态突变。用户已经观察到，仅依靠调整 PID 参数难以彻底解决问题，根源在于当前控制模型缺乏对无人机动力学与 DRC 接口特性的系统建模。为了在不改动硬件平台的前提下实现性能跃升，需要从控制理论与软件架构两个维度重新审视整体方案。

### 2.2 报告目标

1. 梳理当前控制系统的结构、主要模块以及数据流，明确关键假设与耦合关系。
2. 定位现有 PID 控制模型面临的瓶颈，包括杆量与真实加速度之间的非线性关系、通信时延、积分饱和、环境扰动、噪声等因素。
3. 提出至少一种可接受的更高级控制器架构，并给出实现路径、调试方法与风险评估。
4. 针对当前模型，在不完全推倒重来的前提下提供若干增量升级建议，如增加前馈、引入滤波器、构建双环控制等。
5. 为未来的研究与工程落地制定 roadmap，涵盖建模、仿真、软件重构、测试验证等环节。

## 3. 当前系统结构解析

### 3.1 软件模块与数据流

当前仓库的关键模块包括：

- `utils/keyboard.py`：基于 Textual 与 `pynput` 的键盘虚拟摇杆实现，负责捕获键盘输入、生成杆量状态、提供 UI 反馈。该模块在 `JoystickApp` 类中维护一个后台线程监听键盘事件，并周期性通过回调输出杆量状态。
- `utils/keyboardControl.py`：在连接 MQTT、完成控制权请求与心跳维护后，实例化 `JoystickApp` 并将摇杆事件映射至 `send_stick_control` 接口，实现对无人机的实时遥控。
- `control/main.py`：核心的 PID 平面定位控制器，从 VRPN 获得位置与姿态，调用 `PlaneYawController` 计算滚转、俯仰、偏航的杆量偏移，最终调用 `send_stick_control` 输出。
- `control/controller.py`：包含 `PlaneYawController` 以及 PID 算法实现，负责根据当前误差计算控制增量。
- `control/logger.py`：负责数据记录，以便后续分析。
- `djisdk/services`：封装 MQTT 交互，包括心跳线程、杆量发送等底层操作。

总体流程：

1. VRPN 线程持续更新无人机位姿数据（内部虽然还包含速度、加速度量测，但按照当前策略在控制侧不直接读取使用）。
2. 控制主循环以固定频率读取当前位姿，与目标航点计算误差。
3. PID 控制器计算滚转、俯仰、偏航偏移（单位为杆量刻度，范围大约 ±660）。
4. 通过 `send_stick_control` 发送到 DJI DRC，内部通过 MQTT 传输到无人机。
5. 无人机飞控根据收到的遥控指令调整姿态，进而对速度与位置产生影响。

### 3.2 控制对象特性

无人机本体仍由 DJI 原厂飞控管理，Python SDK 是在“虚拟遥控器”层面下发杆量指令。其关键特征：

- 杆量命令对应控制器期望的姿态或角速度，而非直接的速度或位置命令。不同飞行模式下意义略有差异（例如 N 模式与 S 模式的灵敏度不同）。
- 飞控内部具有自身的姿态闭环控制、传感器融合、限幅等机制，外部控制器无法直接访问或调整。
- 由于采用 MQTT 进行网络通信，存在几十毫秒甚至上百毫秒的时延，且其抖动不易精确估计。
- DRC 接口对于持续的饱和杆量输入会触发安全机制，如自动制动或姿态限幅，从而引入额外非线性。

### 3.3 当前 PID 控制器结构

`PlaneYawController` 采用经典的单层 PID 结构：

- 对位置误差（x, y）分别计算 PID 输出，映射到俯仰（pitch）与横滚（roll）偏移。
- Yaw 控制采用独立的 PID，与位置解耦。
- 滚转/俯仰输出直接线性映射至杆量刻度（例如误差越大，杆量偏移越大）。
- 对输出做限制（±MAX_STICK_OUTPUT），避免超过杆量范围。

该结构的核心假设是：杆量偏移与实际加速度或速度呈近似线性关系，从而 PID 在位置误差下仍可收敛。然而在真实飞行中，这种线性假设难以成立。

## 4. 现有问题与根因分析

### 4.1 杆量与动力学之间的非线性

DJI 飞控接收到杆量后，会根据当前飞行模式、姿态、速度、载荷等情况，计算实际的电机转速。杆量与加速度之间的关系受到多个因素影响：

- 非线性系数：杆量偏移越大，飞控越可能触发限幅或安全缓冲，导致有效加速度增益下降。
- 动态变化：电池电压、环境风速、飞行姿态都会改变响应曲线。
- 内部闭环：飞控自身拥有姿态与速度控制，外部 PID 的输出会被内部控制器再处理。

因此，简单的 PID 难以稳定在高精度的位置控制，可能出现如下现象：

1. 高增益下引起振荡或抖动。
2. 低增益下响应慢且存在稳态误差。
3. 积分项容易因为持续误差而增长，却被飞控内部限幅抑制，导致积分饱和和控制器迟滞。

### 4.2 时延与采样率不匹配

控制循环以 60 Hz 或其他固定频率运行，但 VRPN 数据、MQTT 传输以及飞控响应均存在不可忽略的时延。PID 在设计时默认误差反馈即时有效，当延迟显著时，等效的相位裕度降低，容易触发振荡。若外环 PID 调试不当，甚至可能出现“追赶误差”的来回震荡。

### 4.3 未建模的耦合与扰动

无人机的平面位置与 yaw 并非完全解耦，转向会产生侧向速度，外部风扰或动捕系统误差也会注入到位置反馈。当前控制策略缺乏扰动观测与补偿机制，导致在遭遇突发风扰或动捕丢包时，外环 PID 难以恢复。

### 4.4 状态估计与滤波不足

控制器直接使用 VRPN 的位置与四元数。虽然 VRPN 精度较高，但依然存在噪声、偶发跳变及更新频率波动。缺乏低通滤波或 Kalman 滤波，导致控制器对高频噪声敏感，尤其在积分项存在时，噪声会被积分放大。更重要的是，在无法直接使用 VRPN 提供的速度、加速度数据这一约束下，系统若想获得速度信息必须通过位置差分或建立观测器，自身就更容易受到噪声影响，因此状态估计模块的缺失会进一步放大问题。

### 4.5 软件架构上的扩展限制

当前控制器逻辑集中在 `control/controller.py` 中，采用同步循环与全局变量，扩展更复杂的控制策略（如状态空间、模型预测控制）时不够灵活。缺少模块化的系统识别、仿真验证与参数管理机制，难以快速迭代。

## 5. PID 模型的改进空间

在彻底更换控制结构之前，可以从以下方向对 PID 模型进行增强，以缓解部分问题：

### 5.1 引入前馈与轨迹规划

- **速度前馈**：在航点切换时，给出期望速度，并将其转换为预设杆量偏移，减少 PID 需要处理的瞬时误差。
- **加速度前馈**：对预期的曲线或加速度直接施加杆量偏移，利用 PID 做误差修正。
- **S 曲线或多项式轨迹规划**：避免瞬间目标突变，降低 PID 的冲击输入。

在实施上述前馈策略时，需要明确速度、加速度信号均来自离线规划或位置序列的估算，而非直接读取 VRPN 的速度/加速度量测，从一开始就在算法设计中加入滤波与限幅，防止估计噪声放大。

### 5.2 双环（位置-速度）结构

构建外环位置 PID、内环速度 PID。外环输出目标速度，内环再将速度误差转换为杆量。考虑到最终控制程序不能直接读取 VRPN 中的速度或加速度量测，需要通过位置序列差分、低通滤波或观测器估计获取速度反馈，这在设计上必须被明确处理。即便如此，双环结构仍能让 PID 在速度层面工作，从而与杆量之间建立更接近线性的关系，只是速度估计模块需要格外稳健。

### 5.3 增加滤波与延时补偿

- 对位置与速度误差使用一阶低通滤波，滤除高频噪声。
- 引入 Smith Predictor 或简单的延时补偿（例如对误差进行前瞻预测），减轻时延带来的相位滞后。

### 5.4 反积分饱和与软限幅

- 为积分项添加 anti-windup 机制，当输出饱和或误差方向反转时，快速衰减积分。
- 使用软限幅（例如通过双曲正切）逐渐逼近最大杆量，避免突然撞上硬限。

### 5.5 自适应增益或增益调度

- 根据误差大小、当前位置、无人机高度等因素调整 PID 增益。误差大时使用低增益以保证稳定，接近目标时提高增益以缩小稳态误差。

这些增量性改动无需全面更换控制框架，却能显著提高系统的鲁棒性。然而，要获得本质提升，仍需要引入更高级的控制策略。

## 6. 高阶控制器方案

本节提出三类具有代表性的升级方案：基于物理建模的级联控制、线性二次调节器（LQR）/线性二次高斯（LQG）以及模型预测控制（MPC）。每种方案均结合实际可行性、所需工作量与期望收益进行了分析。

### 6.1 方案一：基于动力学建模的级联控制

#### 6.1.1 架构概述

该方案借鉴常规无人机控制器的双环结构，将控制层级划分为：

1. **位置外环**：根据目标位置与当前位置计算期望速度（或加速度）。
2. **速度中环**：将速度误差转化为期望姿态（roll, pitch），同时计算 yaw 指令。
3. **姿态内环**：由于无法直接控制姿态，只能通过 DRC 杆量近似姿态指令。可通过线性化模型，将期望姿态转换为杆量偏移。

#### 6.1.2 关键步骤

1. **系统辨识**：通过实验记录杆量输入与姿态、位置轨迹的关系，借助离线数值微分或观测器估计速度后拟合一阶或二阶模型。例如，假设 roll 杆量与横向速度之间满足一阶惯性 `v_dot = a * (u - v)`，其中速度来自离线估计而非直接传感。通过最小二乘或递推最小二乘识别参数 `a`、时间常数等。
2. **外环设计**：位置误差经 PD 控制得到期望速度 `v_ref`，该速度将由在线观测器或滤波的差分估计提供反馈。
3. **中环设计**：速度误差通过 PI 控制得到期望姿态角 `phi_ref`、`theta_ref`，同时确保速度估计噪声不会放大。
4. **姿态转杆量**：根据辨识得到的增益将姿态角换算为杆量偏移，必要时使用查表或多项式逼近。
5. **抗扰增强**：在中环中引入扰动观测器（DOB）或扩展状态观测器（ESO），估计外部干扰并补偿。

#### 6.1.3 优势与挑战

优势：

- 更贴近无人机常规控制架构，可直接利用经验公式与已有研究成果。
- 通过辨识提高杆量—姿态—速度之间的映射准确度，降低纯 PID 的盲调成本。
- 双环结构对噪声较为鲁棒，外环减轻内环负担。

挑战：

- 需要大量实验数据进行系统辨识，且需确保在安全范围内试飞。
- 依赖从位置数据推导的速度或加速度估计，需要高质量滤波与稳定的观测器。
- 在极端情况下依然受到 DJI 飞控内部限幅约束，无法实现完全理想的姿态跟踪。

### 6.2 方案二：LQR / LQG（线性二次调节器 / 高斯调节器）

#### 6.2.1 基本思想

LQR 基于线性状态空间模型，通过求解代数 Riccati 方程获得最优状态反馈增益，实现对系统的二次指标最小化。结合卡尔曼滤波器的 LQG 可以在存在噪声的情况下进行状态估计与控制。

#### 6.2.2 应用步骤

1. **线性化模型建立**：围绕悬停点，对平面动力学进行线性化，得到状态变量 `x = [x, y, vx, vy, phi, theta, p, q]` 等，控制输入为杆量偏移 `u = [u_roll, u_pitch]`。
2. **控制增益求解**：设定状态权重矩阵 `Q` 与输入权重 `R`，求解 Riccati 方程得到反馈矩阵 `K`。
3. **状态估计**：由于无法直接读取 VRPN 的速度与加速度量测，需要构建卡尔曼滤波器或其他观测器，对 VRPN 位置、姿态进行融合并通过数值微分/动力学模型估计速度与角速度，从而构造观测矩阵。
4. **输入映射**：将 LQR 输出的“期望加速度或姿态”映射为实际杆量。

#### 6.2.3 优劣分析

优势：

- LQR 在理论上可获得最优的线性反馈，调参只需调整权重矩阵，避免反复试错。
- LQG 能同时处理噪声估计与控制，提升系统对动捕噪声的鲁棒性。

挑战：

- 状态空间模型的准确性对效果影响极大，需要投入时间进行建模与验证。
- 需要实时矩阵运算，对 Python 控制循环性能提出更高要求（可借助 NumPy/SciPy）。
- DRC 的非线性与饱和会破坏线性最优性，需要配合抗饱和策略。

### 6.3 方案三：模型预测控制（MPC）

#### 6.3.1 概述

MPC 在每个控制周期解决一个有限时间优化问题，预测系统未来行为并约束输入与状态，适合处理带约束的多变量控制问题。将无人机平面动力学建模为离散时间系统后，MPC 可以直接考虑杆量限幅、速度安全限值等条件。

#### 6.3.2 实施流程

1. **离散模型构建**：基于离散化的状态方程 `x_{k+1} = A x_k + B u_k`，其中 `x` 包含位置、速度（速度需通过观测器估计而非直接测量），`u` 为杆量偏移。
2. **代价函数设计**：最小化未来 `N` 步内的误差平方和与输入变化平方和，典型形式为 `sum (x_k - x_ref)^T Q (x_k - x_ref) + u_k^T R u_k`。
3. **约束设置**：加入杆量上下限、速度或加速度约束，满足飞行安全需求。
4. **求解器选择**：可使用 `cvxpy` 加 `OSQP`/`GUROBI` 等求解器，或自定义 ADMM/快速梯度法。
5. **滚动优化**：每个周期解决一次优化，取第一步输入施加到系统，重复迭代。

#### 6.3.3 优势与挑战

优势：

- 明确处理约束，控制行为可解释。
- 能根据预测提前修正输入，弥补时延带来的影响。
- 便于整合多目标控制，如多无人机协同、避障等。

挑战：

- 对实时性要求高，需保证在 10~20 ms 内完成优化计算。
- 需要精确模型与噪声估计，模型失配会降低性能。
- 代码实现复杂度较高，需要良好的软件架构支撑。

## 7. 综合建议与混合策略

考虑到项目团队当前的资源、开发周期以及对安全性的高要求，建议采用“增量优化 + 阶段性升级”的混合策略。具体路径如下：

1. **短期（1~2 周）**：对现有 PID 框架进行增强，引入滤波、前馈、反积分饱和机制。搭建统一的参数管理与日志分析工具，确保调参过程可追溯。这一阶段通过较小改动快速提升稳定性。
2. **中期（2~4 周）**：开展系统辨识实验，建立杆量-速度的近似模型，实现双环控制。同步完善仿真平台（可使用 Python 的 `pybullet` 或简化动力学仿真），验证控制策略。
3. **中长期（4~8 周）**：在仿真与小范围试飞验证的基础上，引入 LQR/LQG 或 MPC。先在单轴或低维模型上试验，再扩展到全平面控制。过程中不断校正模型、优化求解器性能。
4. **长期（8 周以上）**：探索更高级的自适应控制、学习型控制（如 reinforcement learning with safety constraints），并与真实飞行数据闭环迭代。

## 8. 架构改造与代码建议

为支持上述策略，需要对软件架构进行一定重构：

### 8.1 控制器接口抽象

- 定义 `BaseController` 抽象类，统一 `update(state, target, dt)` 接口，便于不同控制器替换。
- 将 PID、双环控制、LQR、MPC 等实现为派生类，通过配置文件选择。
- 引入状态对象与参数对象，避免使用全局变量。

### 8.2 数据管线模块化

- 将 VRPN 数据解析、滤波、状态估计封装成独立模块，提供统一的状态对象（位置、估计得到的速度、姿态、偏航率等），确保任何需要速度信息的模块都通过同一个观测器输出以满足“不直接使用原始速度、加速度量测”的约束。
- 将日志记录与可视化接口统一管理，方便比较不同控制器的性能。

### 8.3 仿真与真实飞行统一接口

- 构建模拟器接口 `SimulatedDrone`，在不连接真实 DJI 的情况下对控制器进行回放测试。
- 真实飞行时替换为 `DRCDrone`, 但提供相同的控制接口。

### 8.4 参数管理与实验记录

- 使用 YAML 或 JSON 管理控制参数，支持版本管理。
- 自动记录试飞参数、控制器类型、日志路径，实现可追溯性。

## 9. 实施路线与时间规划

| 阶段 | 周期 | 关键任务 | 输出成果 |
| --- | --- | --- | --- |
| 阶段 A | 第 1~2 周 | 引入滤波、反积分饱和；搭建参数管理 | 稳定的增强 PID 控制器 |
| 阶段 B | 第 3~4 周 | 系统辨识、双环控制实现；搭建仿真环境 | 具有速度内环（基于位置估算）的控制模块 |
| 阶段 C | 第 5~8 周 | 尝试 LQR/MPC；优化求解器与状态估计 | 高阶控制器原型及仿真报告 |
| 阶段 D | 第 9 周起 | 真实飞行验证、性能对比；迭代调优 | 飞行数据集与最终评估报告 |

## 10. 风险评估与缓解措施

1. **模型失配风险**：由于 DJI 飞控内部逻辑难以完全建模，可能导致双环或 LQR 效果不佳。缓解：在每次控制策略升级前，进行充分的仿真与离线回放测试，采用渐进式增益调整。
2. **安全风险**：高阶控制器在调试阶段可能产生异常杆量，导致飞行不稳定。缓解：设置安全区域、限幅、自动悬停策略，并安排有经验的安全员准备随时切换手动控制。
3. **软件复杂度增加**：引入新模块后，系统耦合度提升。缓解：严格遵守模块化设计、撰写文档与单元测试，确保每个控制器独立可测试。
4. **实时性约束**：MPC 等算法占用 CPU 时间较多。缓解：优化代码、使用 C 扩展或 PyPy，必要时迁移到 C++ 实现。
5. **数据质量**：VRPN 丢帧或噪声会导致控制性能下降。缓解：部署遗失补偿算法、卡尔曼滤波，以及冗余传感器（如 IMU 读数）。

## 11. 测试与验证策略

### 11.1 仿真测试

- 构建包含随机风扰、命令时延、噪声的仿真环境，对各控制器进行 Monte Carlo 测试。
- 验证指标包括：最大偏差、到达时间、稳定时间、平均能耗、控制输入平滑度。

### 11.2 半实物测试

- 使用录制好的 VRPN 数据进行离线回放，以验证控制算法对不同轨迹的响应。
- 在安全区域放置无人机但不解锁电机，通过 DRC 接口记录杆量输出，观察是否存在尖峰或异常。

### 11.3 真实飞行验证

- 按照风险等级设定飞行场景，从简单悬停、阶跃输入逐步过渡到复杂航点。
- 每次飞行后自动生成总结报告，比较不同控制器的性能指标。

## 12. 后续研究方向

1. **自适应控制**：实时估计系统参数，根据辨识结果调整控制增益，提升鲁棒性。
2. **学习型控制**：在保证安全的前提下，引入强化学习或模仿学习，通过离线数据训练智能控制器。
3. **多无人机协调控制**：在单机稳定后，研究编队控制与冲突检测算法。
4. **视觉与动捕融合**：结合机载视觉、IMU 提供的反馈，提升在动捕环境以外的扩展性。
5. **容错与安全**：建立故障检测机制，当 VRPN 失效或通信异常时自动降级控制策略。

## 13. 结论

当前基于位置 PID 的控制模型在实现路径上简单可行，但由于输出端是杆量这一“加速度类”指令，天然存在建模偏差、时延、饱和等问题。单纯调节 PID 参数无法彻底解决这些结构性隐患。通过对现有系统的深入分析可以看出：

1. 需要从系统辨识、双环控制、状态估计等方向逐步增强控制器，使之更贴合无人机动力学。
2. LQR/LQG 与 MPC 等高阶方法在理论上能够显著提升性能，但实施需要扎实的模型与软件支撑。
3. 通过阶段性计划可降低风险，先强化 PID，再引入级联控制，最终尝试更高级的最优或预测控制。
4. 由于 DRC 接口限制，不可能完全复制机载飞控的控制效果，但通过充分建模与软件工程实践，仍可大幅提升稳定性与响应速度。

本报告提供的措施与路线为团队未来数个月的改进工作奠定方向。下一步建议先完成短期的 PID 增强与数据管线重构，随后以系统辨识为支撑推进双环控制实验。最终可在仿真与实际试飞基础上评估 LQR 或 MPC 的可行性，实现控制性能的跨越式提升。
