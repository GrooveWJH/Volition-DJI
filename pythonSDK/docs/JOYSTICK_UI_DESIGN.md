# 虚拟摇杆 UI 设计说明

## 设计理念

基于 **层次感、可读性、方向性** 三大原则，重新设计虚拟摇杆可视化界面。

---

## 视觉层次（从外到内）

### 1️⃣ 圆形边界（最外层）
- **字符**: `◯` (Unicode 圆圈)
- **颜色**: `dim blue` (深蓝色，低对比度)
- **用途**: 定义摇杆活动范围
- **算法**: 距离中心 = `sqrt(x² + y²)` ≈ 半径 size

```python
dist_from_center = (x**2 + y**2) ** 0.5
if abs(dist_from_center - size) < 0.8:
    # 绘制圆形边界
```

### 2️⃣ 中心十字（中间层）
- **字符**: `┼` (交叉) / `│` (竖线) / `─` (横线)
- **颜色**: `dim white` (暗灰色)
- **用途**: 标记中值位置（1024）
- **改进点**: 使用更细腻的 Unicode 字符，替换粗糙的 ASCII `╋`

### 3️⃣ 摇杆位置指示器（最内层，最醒目）
- **尺寸**: 3x3 像素区域（`abs(x - x_pos) <= 1`）
- **颜色/字符**: 根据偏移量动态变化

---

## 颜色方案（渐进式）

### 📍 中心区域（偏移量 < 10%）
- **字符**: `●` (圆点)
- **颜色**: `bold yellow` (亮黄色)
- **含义**: 摇杆在中值位置（几乎无偏移）

```python
offset_magnitude = sqrt(x_percent² + y_percent²)
if offset_magnitude < 10:
    Text("●", style="bold yellow")
```

### 📍 中等偏移（10% ≤ 偏移量 < 50%）
- **字符**: `◆` (菱形)
- **颜色**:
  - **正向**（向上/向右）: `bold green` (亮绿色)
  - **负向**（向下/向左）: `bold red` (亮红色)
- **含义**: 常规操作范围

```python
elif offset_magnitude < 50:
    if x_percent > 0 or y_percent > 0:
        Text("◆", style="bold green")  # 正向
    else:
        Text("◆", style="bold red")    # 负向
```

### 📍 大偏移（偏移量 ≥ 50%）
- **字符**: `█` (实心方块)
- **颜色**:
  - **正向**: `bold bright_green` (超亮绿色)
  - **负向**: `bold bright_red` (超亮红色)
- **含义**: 极限操作（接近最大/最小值）

```python
else:  # offset_magnitude >= 50
    if x_percent > 0 or y_percent > 0:
        Text("█", style="bold bright_green")
    else:
        Text("█", style="bold bright_red")
```

---

## 技术实现

### Rich Text 对象渲染
使用 `Text` 对象代替纯字符串，支持 ANSI 颜色：

```python
line_parts = []  # 每个字符是一个 Text 对象
for x in range(-size, size + 1):
    if condition:
        line_parts.append(Text("●", style="bold yellow"))
    else:
        line_parts.append(Text(" "))

# 合并为一行
line_text = Text()
for part in line_parts:
    line_text.append(part)
lines.append(line_text)

# 使用 Rich Group 组合多行
joystick_display = RichGroup(*lines)
```

### 圆形边界算法
使用数学距离公式 + 容差（0.8）绘制圆形：

```python
dist_from_center = (x**2 + y**2) ** 0.5
if abs(dist_from_center - size) < 0.8:
    # 这个点在圆周上
```

**为什么是 0.8？**
- 字符网格是离散的（整数坐标）
- 容差太小（如 0.5）→ 圆圈不连续
- 容差太大（如 1.5）→ 圆圈变粗

---

## 对比：改进前 vs 改进后

| 元素 | 改进前 | 改进后 | 提升点 |
|------|--------|--------|--------|
| **边界** | 无 | `◯` (蓝色圆圈) | 清晰定义活动范围 |
| **中心** | `╋` `│` `─` (粗糙) | `┼` `│` `─` (细腻) + 暗色 | 更精致，低干扰 |
| **摇杆** | `●` / `█` (单色) | `●` / `◆` / `█` (渐变色) | 方向性 + 视觉反馈 |
| **颜色** | 无 | 黄色(中心) / 绿色(正) / 红色(负) | 直观区分状态 |

---

## 实际效果示例

### 中心位置（中值 1024）
```
    ◯◯◯◯◯◯◯◯◯
   ◯◯◯◯ │ ◯◯◯◯
  ◯◯◯    │    ◯◯◯
 ◯        │        ◯
 ◯────────●●●────────◯  ← 亮黄色 ●
 ◯        │        ◯
  ◯◯◯    │    ◯◯◯
```

### 中等偏移（向右上，绿色）
```
    ◯◯◯◯◯◯◯◯◯
   ◯◯◯◯ │ ◯◯◯◯
  ◯◯◯    │ ◆◆◆◯◯◯  ← 绿色 ◆
 ◯        │ ◆◆◆    ◯
 ◯────────┼ ◆◆◆────◯
 ◯        │        ◯
```

### 极限偏移（向左下，亮红色）
```
    ◯◯◯◯◯◯◯◯◯
   ◯◯◯◯ │ ◯◯◯◯
  ◯◯◯    │    ◯◯◯
 ◯        │        ◯
 ◯────────┼─────────◯
 ◯███     │        ◯  ← 亮红色 █
  ███     │     ◯◯◯
```

---

## 设计决策解释

### Q1: 为什么用 `◆` 而不是 `●`？
**A**: 区分状态层次：
- `●` (圆点) = 中心（中值）
- `◆` (菱形) = 中等偏移
- `█` (方块) = 极限偏移

字符形状变化 + 颜色变化 = 双重视觉反馈

### Q2: 为什么用圆形边界？
**A**:
- 真实摇杆是圆形的（符合物理直觉）
- 清晰定义活动范围（避免越界误解）
- 美观性提升（vs 方形网格）

### Q3: 为什么中心十字用暗色？
**A**:
- 背景参考线，不应抢夺注意力
- 降低视觉噪音，突出摇杆位置
- 保持可见性的同时减少干扰

### Q4: 为什么正向用绿色、负向用红色？
**A**:
- 通用直觉：绿色 = 前进/上升，红色 = 后退/下降
- 快速识别：无需看数值，颜色即可判断方向
- 符合无人机操作习惯

---

## 测试方法

### 运行预览测试
```bash
python test_joystick_ui.py
```

### 运行完整交互界面
```bash
python utils/keyboard.py
```

### 测试场景
1. 中心位置 → 黄色 `●`
2. 小幅移动 → 绿色/红色 `◆`
3. 大幅移动 → 亮绿色/亮红色 `█`
4. 极限位置 → 边界附近的 `█`
5. 对角线移动 → 同时显示 X/Y 轴偏移

---

## 性能优化

### 使用 Rich Text 的性能影响
- **CPU 消耗**: 每帧渲染 441 个字符（21x21 网格）
- **刷新率**: 20Hz（每 50ms 更新一次）
- **开销**: Rich Text 对象创建 + ANSI 转义序列

**优化策略**:
- 缓存不变的边界字符（可选）
- 减少 Text 对象创建（当前每次重建）
- 如果卡顿，可降低 `update_interval` (默认 0.05s)

---

## 未来改进方向

1. **渐变色支持**: 根据偏移百分比使用连续色谱（需要 True Color 支持）
2. **运动轨迹**: 显示历史路径（淡化的旧位置）
3. **动态边界**: 根据实际最大杆量动态调整圆形大小
4. **ASCII 降级模式**: 对不支持 Unicode 的终端提供纯 ASCII 备选方案

---

## 总结

新设计通过 **分层渲染 + 渐进式颜色 + 符号语义化**，显著提升了虚拟摇杆的可读性和美观度，同时保持了 TUI 应用的性能要求。

**核心改进**:
- ✅ 圆形边界（清晰定义范围）
- ✅ 渐变色指示器（黄→绿/红→亮绿/亮红）
- ✅ 符号语义化（`●` / `◆` / `█`）
- ✅ 低干扰背景（暗色十字）
- ✅ 零新增依赖（仅用 Rich 已有功能）

---

**设计作者**: Claude (AI UI Designer)
**实现日期**: 2025-10-25
**技术栈**: Python 3 + Textual + Rich
