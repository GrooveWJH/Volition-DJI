# Control Module - ä½¿ç”¨æŒ‡å—

PIDæ§åˆ¶æ¨¡å—ï¼Œç”¨äºDJIæ— äººæœºçš„å¹³é¢å®šä½å’ŒYawè§’æ§åˆ¶ã€‚

## ğŸ“‹ ç›®å½•ç»“æ„

```
control/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ config.py           # é…ç½®å‚æ•°ï¼ˆPIDå¢ç›Šã€é˜ˆå€¼ç­‰ï¼‰
â”œâ”€â”€ pid.py              # PIDæ§åˆ¶å™¨åŸºç¡€ç±»
â”œâ”€â”€ controller.py       # å¹³é¢ã€Yawæ§åˆ¶å™¨
â”œâ”€â”€ logger.py           # æ•°æ®è®°å½•å™¨ï¼ˆæ”¯æŒPIDåˆ†é‡è®°å½•ï¼‰
â”œâ”€â”€ visualize.py        # æ•°æ®å¯è§†åŒ–å·¥å…·
â”œâ”€â”€ main.py             # å¹³é¢+Yawæ§åˆ¶ä¸»ç¨‹åº
â”œâ”€â”€ yaw_main.py         # Yawå•ç‹¬æ§åˆ¶ä¸»ç¨‹åº
â””â”€â”€ README.md           # æœ¬æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1ï¸âƒ£ è¿è¡Œå¹³é¢ä½ç½®+Yawè§’æ§åˆ¶

**æµ‹è¯•åœºæ™¯**: æ— äººæœºæŒ‰èˆªç‚¹é¡ºåºé£è¡Œï¼ŒåŒæ—¶æ§åˆ¶XYä½ç½®å’ŒYawè§’åº¦

```bash
# ä»pythonSDKç›®å½•è¿è¡Œ
python control/main.py

# æˆ–ä»controlç›®å½•è¿è¡Œ
cd control
python main.py
```

**æ•°æ®ä¿å­˜ä½ç½®**: `data/<timestamp>/control_data.csv`

**æ•°æ®å­—æ®µ**:
- ä½ç½®: `target_x`, `target_y`, `current_x`, `current_y`, `distance`
- è§’åº¦: `target_yaw`, `current_yaw`, `error_yaw`
- æ§åˆ¶è¾“å‡º: `roll_offset`, `pitch_offset`, `yaw_offset`, `roll_absolute`, `pitch_absolute`, `yaw_absolute`
- **PIDåˆ†é‡**: `x_pid_p`, `x_pid_i`, `x_pid_d` (Xè½´), `y_pid_p`, `y_pid_i`, `y_pid_d` (Yè½´), `yaw_pid_p`, `yaw_pid_i`, `yaw_pid_d` (Yaw)
- å…¶ä»–: `timestamp`, `waypoint_index`

---

### 2ï¸âƒ£ è¿è¡ŒYawè§’å•ç‹¬æ§åˆ¶

**æµ‹è¯•åœºæ™¯**: æ— äººæœºåªæ—‹è½¬åˆ°ç›®æ ‡è§’åº¦ï¼Œä¸æ”¹å˜ä½ç½®

```bash
# ä»pythonSDKç›®å½•è¿è¡Œ
python control/yaw_main.py

# æˆ–ä»controlç›®å½•è¿è¡Œ
cd control
python yaw_main.py
```

**æ•°æ®ä¿å­˜ä½ç½®**: `data/yaw/<timestamp>/yaw_control_data.csv`

**æ•°æ®å­—æ®µ**:
- è§’åº¦: `target_yaw`, `current_yaw`, `error_yaw`
- æ§åˆ¶è¾“å‡º: `yaw_offset`, `yaw_absolute`
- **PIDåˆ†é‡**: `yaw_pid_p`, `yaw_pid_i`, `yaw_pid_d`
- å…¶ä»–: `timestamp`, `target_index`

---

## ğŸ“Š æ•°æ®å¯è§†åŒ–

### æ–¹æ³•1: æŒ‡å®šæ—¶é—´æˆ³ç›®å½•

```bash
# å¹³é¢+Yawæ•°æ®å¯è§†åŒ–
python control/visualize.py data/20241030_143022

# Yawå•ç‹¬æ•°æ®å¯è§†åŒ–
python control/visualize.py data/yaw/20241030_143500
```

### æ–¹æ³•2: ä½¿ç”¨latestå¿«æ·æ–¹å¼

æ¯æ¬¡æ§åˆ¶ç»“æŸåï¼Œæ•°æ®ä¼šè‡ªåŠ¨å¤åˆ¶åˆ° `latest` ç›®å½•ï¼š

```bash
# æŸ¥çœ‹æœ€æ–°çš„å¹³é¢+Yawæµ‹è¯•æ•°æ®
python control/visualize.py data/latest

# æŸ¥çœ‹æœ€æ–°çš„Yawå•ç‹¬æµ‹è¯•æ•°æ®
python control/visualize.py data/yaw/latest
```

### å¯è§†åŒ–è¾“å‡º

#### å¹³é¢+Yawæ§åˆ¶ (8ä¸ªå­å›¾)
1. **Xè½´è·Ÿè¸ª** - ç›®æ ‡X vs å½“å‰X
2. **Yè½´è·Ÿè¸ª** - ç›®æ ‡Y vs å½“å‰Y
3. **Yawè§’è·Ÿè¸ª** - ç›®æ ‡Yaw vs å½“å‰Yaw
4. **è·ç¦»è¯¯å·®** - åˆ°ç›®æ ‡ç‚¹çš„æ¬§æ°è·ç¦»
5. **XYæ†é‡è¾“å‡º** - Rollå’ŒPitchæ†é‡
6. **Yawæ†é‡è¾“å‡º** - Yawæ†é‡
7. **Xè½´PIDåˆ†é‡** - Pé¡¹(çº¢)ã€Ié¡¹(ç»¿)ã€Dé¡¹(è“)
8. **Yè½´PIDåˆ†é‡** - Pé¡¹(çº¢)ã€Ié¡¹(ç»¿)ã€Dé¡¹(è“)

#### Yawå•ç‹¬æ§åˆ¶ (3ä¸ªå­å›¾)
1. **Yawè§’è·Ÿè¸ª** - ç›®æ ‡Yaw vs å½“å‰Yaw
2. **Yawæ†é‡è¾“å‡º** - æ†é‡å€¼å’Œ1024ä¸­ä½çº¿
3. **Yaw PIDåˆ†é‡** - Pé¡¹(çº¢)ã€Ié¡¹(ç»¿)ã€Dé¡¹(è“)

### è¾“å‡ºæ–‡ä»¶

- **HTMLæ–‡ä»¶**: `<data_dir>/plane_yaw_analysis.html` æˆ– `yaw_only_analysis.html`
- **è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨**: å›¾è¡¨ä¼šåœ¨é»˜è®¤æµè§ˆå™¨ä¸­æ‰“å¼€
- **äº¤äº’å¼**: æ”¯æŒç¼©æ”¾ã€å¹³ç§»ã€æ‚¬åœæŸ¥çœ‹æ•°å€¼

---

## âš™ï¸ é…ç½®å‚æ•°

ç¼–è¾‘ `control/config.py` ä¿®æ”¹å‚æ•°ï¼š

### å¹³é¢+Yawæ§åˆ¶å‚æ•°

```python
# PIDå¢ç›Š (XYå¹³é¢)
KP_XY = 150.0   # æ¯”ä¾‹å¢ç›Š
KI_XY = 0.0     # ç§¯åˆ†å¢ç›Š
KD_XY = 200.0   # å¾®åˆ†å¢ç›Š

# PIDå¢ç›Š (Yawè§’)
KP_YAW = 8.0
KI_YAW = 0.5
KD_YAW = 15.0

# æ§åˆ¶é˜ˆå€¼
TOLERANCE_XY = 0.05          # XYåˆ°è¾¾é˜ˆå€¼ (ç±³)
TOLERANCE_YAW = 3.0          # Yawåˆ°è¾¾é˜ˆå€¼ (åº¦)
ARRIVAL_STABLE_TIME = 1.5    # ç¨³å®šæ—¶é—´ (ç§’)

# èˆªç‚¹å®šä¹‰
WAYPOINTS = [
    (0.0, 0.0),    # èˆªç‚¹0
    (0.5, 0.0),    # èˆªç‚¹1
    (0.5, 0.5),    # èˆªç‚¹2
    (0.0, 0.5),    # èˆªç‚¹3
]

# æ§åˆ¶é¢‘ç‡
CONTROL_FREQUENCY = 50  # Hz
```

### Yawå•ç‹¬æ§åˆ¶å‚æ•°

```python
# PIDå¢ç›Š (Yawè§’)
KP_YAW_ONLY = 3.0    # æ¯”ä¾‹å¢ç›Š
KI_YAW_ONLY = 0.0    # ç§¯åˆ†å¢ç›Šï¼ˆç¦ç”¨ä»¥é¿å…æŒ¯è¡ï¼‰
KD_YAW_ONLY = 50.0   # å¾®åˆ†å¢ç›Šï¼ˆå¼ºé˜»å°¼ï¼‰

# ç›®æ ‡è§’åº¦åºåˆ—
TARGET_YAWS = [0, 90, 180, -90]  # åº¦

# æ§åˆ¶é¢‘ç‡
CONTROL_FREQUENCY_YAW = 60  # Hz

# æ§åˆ¶é˜ˆå€¼
TOLERANCE_YAW_ONLY = 1.0         # åˆ°è¾¾é˜ˆå€¼ (åº¦)
ARRIVAL_STABLE_TIME = 2.0        # ç¨³å®šæ—¶é—´ (ç§’)
MAX_YAW_STICK_OUTPUT = 660       # æœ€å¤§æ†é‡åç§»
```

---

## ğŸ¯ PIDè°ƒå‚æŒ‡å—

### ç†è§£PIDä¸‰ä¸ªåˆ†é‡

ä»å¯è§†åŒ–å›¾è¡¨çš„PIDåˆ†é‡å­å›¾ä¸­è§‚å¯Ÿï¼š

- **Pé¡¹ (çº¢è‰²)**:
  - ä¸è¯¯å·®æˆæ­£æ¯”
  - å¦‚æœPé¡¹è¿‡å¤§ â†’ ç³»ç»Ÿè¿‡å†²ã€éœ‡è¡
  - å¦‚æœPé¡¹è¿‡å° â†’ å“åº”ç¼“æ…¢

- **Ié¡¹ (ç»¿è‰²)**:
  - ç´¯ç§¯å†å²è¯¯å·®
  - å¦‚æœIé¡¹æŒç»­å¢é•¿ â†’ å¯èƒ½å¯¼è‡´è¶…è°ƒå’ŒæŒ¯è¡
  - å¦‚æœå­˜åœ¨ç¨³æ€è¯¯å·® â†’ é€‚å½“å¢åŠ Ki

- **Dé¡¹ (è“è‰²)**:
  - è¯¯å·®å˜åŒ–ç‡ï¼ˆé˜»å°¼ä½œç”¨ï¼‰
  - å¦‚æœDé¡¹å‰§çƒˆæ³¢åŠ¨ â†’ Kdå¯èƒ½è¿‡å¤§ï¼Œå¯¹å™ªå£°æ•æ„Ÿ
  - å¦‚æœéœ‡è¡ä¸¥é‡ â†’ å¢åŠ Kdä»¥å¢å¼ºé˜»å°¼

### è°ƒå‚æ­¥éª¤

1. **ä»Pé¡¹å¼€å§‹**:
   ```python
   KP = 3.0, KI = 0.0, KD = 0.0
   ```
   è§‚å¯Ÿæ˜¯å¦èƒ½æ¥è¿‘ç›®æ ‡ï¼Œå…è®¸ä¸€å®šè¿‡å†²

2. **å¢åŠ Dé¡¹æ¶ˆé™¤éœ‡è¡**:
   ```python
   KP = 3.0, KI = 0.0, KD = 50.0
   ```
   è§‚å¯ŸPIDåˆ†é‡å›¾ï¼ŒDé¡¹åº”è¯¥æŠ‘åˆ¶Pé¡¹çš„å‰§çƒˆå˜åŒ–

3. **è°¨æ…å¯ç”¨Ié¡¹**:
   ```python
   KP = 3.0, KI = 0.1, KD = 50.0
   ```
   åªæœ‰åœ¨å­˜åœ¨æŒç»­ç¨³æ€è¯¯å·®æ—¶æ‰å¯ç”¨

### å¸¸è§é—®é¢˜è¯Šæ–­

| ç°è±¡ | PIDåˆ†é‡ç‰¹å¾ | è§£å†³æ–¹æ¡ˆ |
|------|-------------|----------|
| ä¸¥é‡è¿‡å†² | Pé¡¹è¿‡å¤§ï¼ŒDé¡¹ä¸è¶³ | å‡å°Kpï¼Œå¢å¤§Kd |
| æŒç»­éœ‡è¡ | Pé¡¹å’ŒIé¡¹ç›¸äº’ä½œç”¨ | å‡å°Kpï¼Œç¦ç”¨Ki (è®¾ä¸º0) |
| å“åº”ç¼“æ…¢ | Pé¡¹ã€Dé¡¹éƒ½å¾ˆå° | å¢å¤§Kp |
| ç¨³æ€è¯¯å·® | Pé¡¹æ¥è¿‘0ï¼Œä½†ä»æœ‰è¯¯å·® | å¯ç”¨Ki (ä»å°å€¼å¼€å§‹ï¼Œå¦‚0.1) |
| å™ªå£°æ•æ„Ÿ | Dé¡¹å‰§çƒˆæ³¢åŠ¨ | å‡å°Kdï¼Œæˆ–ä½¿ç”¨æ»¤æ³¢ |

---

## ğŸ“ æ•°æ®ç›®å½•ç»“æ„

```
data/
â”œâ”€â”€ 20241030_143022/              # å¹³é¢+Yawæµ‹è¯•1
â”‚   â”œâ”€â”€ control_data.csv          # åŸå§‹æ•°æ®
â”‚   â””â”€â”€ plane_yaw_analysis.html   # å¯è§†åŒ–ç»“æœ
â”œâ”€â”€ 20241030_145500/              # å¹³é¢+Yawæµ‹è¯•2
â”‚   â”œâ”€â”€ control_data.csv
â”‚   â””â”€â”€ plane_yaw_analysis.html
â”œâ”€â”€ latest/                       # æœ€æ–°å¹³é¢+Yawæµ‹è¯•ï¼ˆè‡ªåŠ¨å¤åˆ¶ï¼‰
â”‚   â”œâ”€â”€ control_data.csv
â”‚   â””â”€â”€ plane_yaw_analysis.html
â””â”€â”€ yaw/
    â”œâ”€â”€ 20241030_143500/          # Yawæµ‹è¯•1
    â”‚   â”œâ”€â”€ yaw_control_data.csv
    â”‚   â””â”€â”€ yaw_only_analysis.html
    â”œâ”€â”€ 20241030_150000/          # Yawæµ‹è¯•2
    â”‚   â”œâ”€â”€ yaw_control_data.csv
    â”‚   â””â”€â”€ yaw_only_analysis.html
    â””â”€â”€ latest/                   # æœ€æ–°Yawæµ‹è¯•ï¼ˆè‡ªåŠ¨å¤åˆ¶ï¼‰
        â”œâ”€â”€ yaw_control_data.csv
        â””â”€â”€ yaw_only_analysis.html
```

---

## ğŸ”§ é«˜çº§ç”¨æ³•

### ä»ä»£ç ä¸­ä½¿ç”¨æ§åˆ¶å™¨

```python
from control.controller import PlaneYawController, YawOnlyController
from control.logger import DataLogger

# å¹³é¢+Yawæ§åˆ¶å™¨
controller = PlaneYawController(
    kp_xy=150.0, ki_xy=0.0, kd_xy=200.0,
    kp_yaw=8.0, ki_yaw=0.5, kd_yaw=15.0,
    output_limit=660
)

# è®¡ç®—æ§åˆ¶è¾“å‡ºï¼ˆè¿”å›PIDåˆ†é‡ï¼‰
roll_offset, pitch_offset, yaw_offset, pid_components = controller.compute(
    target_x=0.5, target_y=0.5, target_yaw=90.0,
    current_x=0.3, current_y=0.2, current_yaw=45.0,
    current_time=time.time()
)

# PIDåˆ†é‡ç»“æ„
# pid_components = {
#     'x': (p_term, i_term, d_term),
#     'y': (p_term, i_term, d_term),
#     'yaw': (p_term, i_term, d_term)
# }

# æ•°æ®è®°å½•å™¨ï¼ˆæ”¯æŒPIDåˆ†é‡ï¼‰
logger = DataLogger(enabled=True, field_set='plane_yaw')
logger.log(
    timestamp=current_time,
    target_x=0.5, current_x=0.3, error_x=0.2,
    # ... å…¶ä»–å­—æ®µ ...
    x_pid_p=pid_components['x'][0],
    x_pid_i=pid_components['x'][1],
    x_pid_d=pid_components['x'][2],
    # ... å…¶ä»–PIDåˆ†é‡ ...
)
logger.close()  # è‡ªåŠ¨åˆ›å»ºlatestå‰¯æœ¬
```

### è‡ªå®šä¹‰å­—æ®µè®°å½•

```python
# å®šä¹‰è‡ªå®šä¹‰å­—æ®µ
custom_fields = [
    'timestamp', 'my_data1', 'my_data2', 'my_pid_p', 'my_pid_i', 'my_pid_d'
]

logger = DataLogger(
    enabled=True,
    field_set=custom_fields,  # ä¼ å…¥è‡ªå®šä¹‰å­—æ®µåˆ—è¡¨
    csv_name='my_data.csv',
    subdir='my_experiments'
)

logger.log(
    timestamp=time.time(),
    my_data1=123.456,
    my_data2=789.012,
    my_pid_p=10.0,
    my_pid_i=0.5,
    my_pid_d=2.0
)
```

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæœ‰ä¸¤ä¸ªæµ‹è¯•ç¨‹åºï¼Ÿ

- **`main.py`**: æµ‹è¯•XYå¹³é¢ç§»åŠ¨ + Yawè§’åº¦æ§åˆ¶ï¼ˆå¤æ‚åœºæ™¯ï¼‰
- **`yaw_main.py`**: åªæµ‹è¯•Yawè§’åº¦æ§åˆ¶ï¼ˆç®€åŒ–è°ƒå‚ï¼‰

å»ºè®®å…ˆç”¨ `yaw_main.py` è°ƒå¥½Yawçš„PIDå‚æ•°ï¼Œå†ç”¨ `main.py` æµ‹è¯•å®Œæ•´åŠŸèƒ½ã€‚

### Q2: latestç›®å½•æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

æ¯æ¬¡æµ‹è¯•ç»“æŸåï¼Œæ•°æ®è‡ªåŠ¨å¤åˆ¶åˆ° `latest` ç›®å½•ï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥çœ‹æœ€æ–°ç»“æœï¼š

```bash
# ä¸ç”¨è®°ä½æ—¶é—´æˆ³ï¼Œç›´æ¥æŸ¥çœ‹æœ€æ–°æ•°æ®
python control/visualize.py data/latest
python control/visualize.py data/yaw/latest
```

### Q3: å¦‚ä½•å…³é—­æ•°æ®è®°å½•ï¼Ÿ

ç¼–è¾‘ `control/config.py`:

```python
ENABLE_DATA_LOGGING = False  # æ”¹ä¸ºFalse
```

### Q4: PIDåˆ†é‡å›¾è¡¨çœ‹ä¸åˆ°çº¿ï¼Ÿ

å¯èƒ½æ˜¯PIDå‚æ•°ä¸º0æˆ–æ•°æ®æœªè®°å½•ã€‚æ£€æŸ¥ï¼š

1. ç¡®ä¿ä½¿ç”¨çš„æ˜¯æ–°ç‰ˆæœ¬ä»£ç ï¼ˆæ”¯æŒPIDåˆ†é‡è®°å½•ï¼‰
2. æŸ¥çœ‹CSVæ–‡ä»¶æ˜¯å¦åŒ…å« `*_pid_p`, `*_pid_i`, `*_pid_d` åˆ—
3. æ£€æŸ¥PIDå‚æ•°ä¸å…¨ä¸º0

### Q5: å¦‚ä½•ä¿®æ”¹æ§åˆ¶é¢‘ç‡ï¼Ÿ

ç¼–è¾‘ `control/config.py`:

```python
CONTROL_FREQUENCY = 50      # å¹³é¢+Yawæ§åˆ¶é¢‘ç‡ (Hz)
CONTROL_FREQUENCY_YAW = 60  # Yawå•ç‹¬æ§åˆ¶é¢‘ç‡ (Hz)
```

æ³¨æ„ï¼šé¢‘ç‡è¿‡é«˜å¯èƒ½å¯¼è‡´ç³»ç»Ÿè´Ÿè½½å¢åŠ ï¼Œé¢‘ç‡è¿‡ä½ä¼šé™ä½æ§åˆ¶ç²¾åº¦ã€‚

---

## ğŸ“ æŠ€æœ¯è¯´æ˜

### åæ ‡ç³»ç»Ÿ

- **ä¸–ç•Œåæ ‡ç³»**: VRPNåŠ¨æ•ç³»ç»Ÿæä¾›çš„å…¨å±€åæ ‡
- **æœºä½“åæ ‡ç³»**: æ— äººæœºæœ¬ä½“åæ ‡ç³»ï¼ŒéšYawè§’æ—‹è½¬
- **Yawè§’çº¦å®š**: é€†æ—¶é’ˆæ—‹è½¬ä¸ºæ­£ï¼ˆå³æ‰‹åæ ‡ç³»ï¼ŒZè½´å‘ä¸Šï¼‰

### æ§åˆ¶æ˜ å°„

```
ä¸–ç•Œåæ ‡è¯¯å·® â†’ æœºä½“åæ ‡è¯¯å·® â†’ æ†é‡æ§åˆ¶

Xè½´ (å‰æ–¹å‘) â†’ Pitchæ†é‡ (æ­£å€¼å‰è¿›)
Yè½´ (å·¦æ–¹å‘) â†’ Rollæ†é‡ (è´Ÿå€¼å‘å·¦)
Yawè§’ (é€†æ—¶é’ˆ) â†’ Yawæ†é‡ (è´Ÿå€¼é€†æ—¶é’ˆ)
```

### æ†é‡èŒƒå›´

- **ä¸­ç«‹ä½ç½®**: 1024
- **æœ€å¤§åç§»**: Â±660
- **æœ‰æ•ˆèŒƒå›´**: 364 ~ 1684

---

## ğŸ“š å‚è€ƒèµ„æ–™

- **PIDæ§åˆ¶åŸç†**: `control/pid.py` - å¸¦ç§¯åˆ†é™å¹…çš„æ ‡å‡†PIDå®ç°
- **åæ ‡å˜æ¢**: `control/controller.py:100-133` - ä¸–ç•Œç³»åˆ°æœºä½“ç³»çš„æ—‹è½¬çŸ©é˜µ
- **è§’åº¦å½’ä¸€åŒ–**: `control/controller.py:25-39` - å¤„ç†Â±180Â°è¾¹ç•Œ
- **æ•°æ®è®°å½•**: `control/logger.py` - æ”¯æŒè‡ªå®šä¹‰å­—æ®µçš„å‚æ•°åŒ–è®°å½•å™¨
- **å¯è§†åŒ–**: `control/visualize.py` - è‡ªåŠ¨æ£€æµ‹æ•°æ®ç±»å‹çš„é€šç”¨ç»˜å›¾å·¥å…·

---

**æœ€åæ›´æ–°**: 2024-10-30
**ç‰ˆæœ¬**: 2.0 (æ”¯æŒPIDåˆ†é‡å¯è§†åŒ– + latestå¿«æ·æ–¹å¼)
