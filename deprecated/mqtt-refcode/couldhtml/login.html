<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>DJIé¥æ§å™¨ç™»å½•é¡µé¢</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- å¼•å…¥MQTT.jsåº“ -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      
      .button-row {
        display: flex;
        gap: 10px;
        margin: 20px 0;
      }

      button {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      button:hover {
        transform: translateY(-1px);
      }
      
      #login-button {
        background: #4CAF50;
        color: white;
      }
      
      #login-button:hover {
        background: #45a049;
      }
      
      #logout-button {
        background: #f44336;
        color: white;
      }
      
      #logout-button:hover {
        background: #da190b;
      }
      
      #status-button {
        background: #2196F3;
        color: white;
      }
      
      #status-button:hover {
        background: #0b7dda;
      }
      
      #connection-info {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        background: #f9f9f9;
        border-radius: 6px;
        font-size: 14px;
        line-height: 1.5;
      }
      
      #logs {
        background: #1e1e1e;
        color: #00ff00;
        padding: 15px;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        line-height: 1.4;
      }
      
      .log-item {
        margin: 2px 0;
        padding: 2px 0;
      }
      
      .log-success {
        color: #00ff00;
      }
      
      .log-error {
        color: #ff4444;
      }
      
      .log-info {
        color: #4CAF50;
      }
      
      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
      }
      
      .status-connected {
        background: #4CAF50;
      }
      
      .status-disconnected {
        background: #f44336;
      }
      
      .status-connecting {
        background: #ff9800;
        animation: pulse 1s infinite;
      }
      
      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>DJI äº‘ API æµ‹è¯•</h1>

      <div class="button-row">
        <button id="login-button">ç™»å½•</button>
        <button id="logout-button">æ³¨é”€</button>
        <button id="status-button">çŠ¶æ€æŠ¥å‘Š</button>
      </div>
      
      <div id="connection-info"></div>
      <div id="logs"></div>
    </div>

    <script>
      // DJI é…ç½®å¸¸é‡
      const APP_ID = 171440;
      const LICENSE = "krC5HsEFLzVC8xkKM38JCcSxNEQvsQ/7IoiHEJRaulGiPQildia+n/+bF+SO21pk1JTS8CfaNS+fn8qt+17i3Y7uoqtBOOsdtLUQhqPMb0DVea0dmZ7oZhdP2CuQrQSn1bobS3pQ+MW2eEOq0XCcCkpo+HxAC1r5/33yEDxc6NE=";
      const APP_KEY = "b57ab1ee70f0a78e1797c592742e7d4";
      
      // MQTT é…ç½® - è¿™äº›å€¼ä¼šè¢«æœåŠ¡å™¨æ›¿æ¢
      const MQTT_HOST = "tcp://hostnamehere:1883";
      const MQTT_USERNAME = "userloginhere";
      const MQTT_PASSWORD = "userpasswordhere";
      
      // DOM å…ƒç´ 
      const logsContainer = document.getElementById("logs");
      const connectionInfo = document.getElementById("connection-info");
      
      // MQTT å®¢æˆ·ç«¯å˜é‡
      let mqttClient = null;
      let isConnected = false;
      
      // åˆå§‹åŒ–é¡µé¢
      function initPage() {
        updateConnectionInfo();
        log("é¡µé¢åˆå§‹åŒ–å®Œæˆ", "info");
        log("å¹³å°éªŒè¯çŠ¶æ€ï¼š" + (window.djiBridge ? window.djiBridge.platformIsVerified() : "djiBridgeæœªåŠ è½½"), "info");
      }
      
      // æ›´æ–°è¿æ¥ä¿¡æ¯æ˜¾ç¤º
      function updateConnectionInfo() {
        const statusClass = isConnected ? "status-connected" : "status-disconnected";
        const statusText = isConnected ? "å·²è¿æ¥" : "æœªè¿æ¥";
        
        connectionInfo.innerHTML = `
          <div style="margin-bottom: 10px;">
            <strong>MQTT è¿æ¥é…ç½®</strong>
            <span class="status-indicator ${statusClass}"></span>
            <span>${statusText}</span>
          </div>
          <div><strong>Host:</strong> ${MQTT_HOST}</div>
          <div><strong>Username:</strong> ${MQTT_USERNAME}</div>
          <div><strong>Password:</strong> ${MQTT_PASSWORD}</div>
        `;
      }
      
      // æ—¥å¿—è®°å½•å‡½æ•°
      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logItem = document.createElement("div");
        logItem.className = `log-item log-${type}`;
        logItem.textContent = `[${timestamp}] ${message}`;
        logsContainer.appendChild(logItem);
        logsContainer.scrollTop = logsContainer.scrollHeight;
      }
      
      // MQTT è¿æ¥å‡½æ•°
      function connectMQTT() {
        if (mqttClient) {
          log("MQTT å®¢æˆ·ç«¯å·²å­˜åœ¨ï¼Œå…ˆæ–­å¼€", "info");
          mqttClient.end();
        }
        
        try {
          log("æ­£åœ¨è¿æ¥ MQTT æœåŠ¡å™¨...", "info");
          
          // è§£æMQTT URL
          const url = MQTT_HOST.replace('tcp://', 'ws://') + (MQTT_HOST.includes(':') ? '' : ':1883');
          
          mqttClient = mqtt.connect(url, {
            username: MQTT_USERNAME,
            password: MQTT_PASSWORD,
            clientId: 'dji_rc_' + Math.random().toString(16).substr(2, 8),
            reconnectPeriod: 5000,
            connectTimeout: 10000
          });
          
          mqttClient.on('connect', () => {
            isConnected = true;
            updateConnectionInfo();
            log("MQTT è¿æ¥æˆåŠŸï¼", "success");
            
            // è®¢é˜…ç›¸å…³ä¸»é¢˜
            mqttClient.subscribe('dji/+/status', (err) => {
              if (!err) {
                log("å·²è®¢é˜… dji/+/status ä¸»é¢˜", "success");
              }
            });
          });
          
          mqttClient.on('error', (error) => {
            isConnected = false;
            updateConnectionInfo();
            log("MQTT è¿æ¥é”™è¯¯: " + error.message, "error");
          });
          
          mqttClient.on('close', () => {
            isConnected = false;
            updateConnectionInfo();
            log("MQTT è¿æ¥å·²å…³é—­", "info");
          });
          
          mqttClient.on('message', (topic, message) => {
            log(`æ”¶åˆ°æ¶ˆæ¯ [${topic}]: ${message.toString()}`, "info");
          });
          
        } catch (error) {
          log("MQTT è¿æ¥å¤±è´¥: " + error.message, "error");
        }
      }
      
      // æ–­å¼€MQTTè¿æ¥
      function disconnectMQTT() {
        if (mqttClient) {
          mqttClient.end();
          mqttClient = null;
          isConnected = false;
          updateConnectionInfo();
          log("MQTT è¿æ¥å·²æ–­å¼€", "info");
        }
      }
      
      // DJI Bridge å›è°ƒå‡½æ•°
      function reg_callback() {
        log("DJI Bridge å›è°ƒè§¦å‘ ğŸ‰ å‚æ•°ï¼š" + Array.from(arguments).join(', '), "success");
      }
      
      // äº‹ä»¶ç›‘å¬å™¨
      document.getElementById("login-button").addEventListener("click", function () {
        log("=== å¼€å§‹ç™»å½•æµç¨‹ ===", "info");
        
        // é¦–å…ˆè¿æ¥MQTT
        connectMQTT();
        
        // DJI Bridge éªŒè¯
        if (window.djiBridge) {
          try {
            log("å¼€å§‹éªŒè¯å¹³å°è®¸å¯è¯...", "info");
            const token = window.djiBridge.platformVerifyLicense(APP_ID, APP_KEY, LICENSE);
            log("å¹³å°éªŒè¯çŠ¶æ€ï¼š" + window.djiBridge.platformIsVerified(), "info");

            const register_params = JSON.stringify({
              host: MQTT_HOST,
              connectCallback: "reg_callback",
              username: MQTT_USERNAME,
              password: MQTT_PASSWORD,
            });
            
            log("åŠ è½½ thing ç»„ä»¶ï¼š" + window.djiBridge.platformLoadComponent("thing", register_params), "info");
            log("å½“å‰çŠ¶æ€ï¼š" + window.djiBridge.thingGetConnectState(), "info");
            log("å¼€å§‹è¿æ¥ thingï¼š" + window.djiBridge.thingConnect(MQTT_USERNAME, MQTT_PASSWORD, "reg_callback"), "info");
            log("Thing è¿æ¥çŠ¶æ€ï¼š" + window.djiBridge.thingGetConnectState(), "info");
            
          } catch (error) {
            log("DJI Bridge æ“ä½œé”™è¯¯: " + error.message, "error");
          }
        } else {
          log("djiBridge å¯¹è±¡æœªæ‰¾åˆ°ï¼Œå¯èƒ½ä¸åœ¨ DJI é¥æ§å™¨ç¯å¢ƒä¸­", "error");
        }
      });

      document.getElementById("logout-button").addEventListener("click", function () {
        log("=== å¼€å§‹æ³¨é”€æµç¨‹ ===", "info");
        
        // æ–­å¼€MQTT
        disconnectMQTT();
        
        // DJI Bridge æ³¨é”€
        if (window.djiBridge) {
          try {
            log("å¸è½½ç»„ä»¶ï¼š" + window.djiBridge.platformUnloadComponent("thing"), "info");
          } catch (error) {
            log("DJI Bridge æ³¨é”€é”™è¯¯: " + error.message, "error");
          }
        }
      });

      document.getElementById("status-button").addEventListener("click", function () {
        log("=== çŠ¶æ€æŠ¥å‘Š ===", "info");
        log("MQTT è¿æ¥çŠ¶æ€ï¼š" + (isConnected ? "å·²è¿æ¥" : "æœªè¿æ¥"), "info");
        
        if (window.djiBridge) {
          try {
            log("ç»„ä»¶åŠ è½½çŠ¶æ€ï¼š" + window.djiBridge.platformIsComponentLoaded("thing"), "info");
            log("Thing çŠ¶æ€ï¼š" + window.djiBridge.thingGetConnectState(), "info");
            log("å¹³å°éªŒè¯çŠ¶æ€ï¼š" + window.djiBridge.platformIsVerified(), "info");
          } catch (error) {
            log("DJI Bridge çŠ¶æ€æŸ¥è¯¢é”™è¯¯: " + error.message, "error");
          }
        } else {
          log("djiBridge å¯¹è±¡æœªæ‰¾åˆ°", "error");
        }
      });
      
      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      window.addEventListener('load', initPage);
      
      // å®šä¹‰å…¨å±€å›è°ƒå‡½æ•°
      window.reg_callback = reg_callback;
      
    </script>
  </body>
</html>
