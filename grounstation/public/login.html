<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>DJI é¥æ§å™¨ç™»å½•é¡µé¢</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      .button-row {
        display: flex;
        justify-content: space-between;
      }

      button {
        flex: 1;
        margin: 0 5px;
      }
      #connection-info {
        margin: 12px 0;
        padding: 10px;
        border: 1px solid #f39c12;
        background: #fff8dc;
      }
    </style>
  </head>
  <body>
    <h1>DJI äº‘ API æµ‹è¯•</h1>

    <div class="button-row">
      <button id="login-button">ç™»å½•</button>
      <button id="logout-button">æ³¨é”€</button>
      <button id="raport-button">çŠ¶æ€æŠ¥å‘Š</button>
    </div>
    <div id="connection-info"></div>
    <ul id="logs"></ul>
    <script>
      // DJIé…ç½®å‚æ•° - è¿™äº›å°†ç”±åç«¯åŠ¨æ€æ›¿æ¢
      const APP_ID = 171440;
      const LICENSE = "krC5HsEFLzVC8xkKM38JCcSxNEQvsQ/7IoiHEJRaulGiPQildia+n/+bF+SO21pk1JTS8CfaNS+fn8qt+17i3Y7uoqtBOOsdtLUQhqPMb0DVea0dmZ7oZhdP2CuQrQSn1bobS3pQ+MW2eEOq0XCcCkpo+HxAC1r5/33yEDxc6NE=";
      const APP_KEY = "b57ab1ee70f0a78e1797c592742e7d4";
      
      // MQTTé…ç½®å‚æ•° - è¿™äº›å°†ç”±åç«¯æœåŠ¡æ ¹æ®é…ç½®åŠ¨æ€æ›¿æ¢
      const MQTT_HOST = "tcp://{{MQTT_HOST}}:{{MQTT_PORT}}";
      const MQTT_USERNAME = "{{MQTT_USERNAME}}";
      const MQTT_PASSWORD = "{{MQTT_PASSWORD}}";
      
      var fieldList = document.getElementById("logs");
      var connectionInfo = document.getElementById("connection-info");
      connectionInfo.textContent =
        "å½“å‰ MQTT é…ç½® -> Host: " +
        MQTT_HOST +
        " ï½œ Username: " +
        MQTT_USERNAME +
        " ï½œ Password: " +
        MQTT_PASSWORD;
        
      var log = function (msg) {
        var li = document.createElement("li");
        li.innerText = msg;
        fieldList.appendChild(li);
      };
      
      var reg_calback = function () {
        log("å›è°ƒè§¦å‘ğŸ‰ å‚æ•°ï¼š" + Array.from(arguments));
      };
      
      var loginButton = document.getElementById("login-button");
      loginButton.addEventListener("click", function () {
        log("å¼€å§‹éªŒè¯å¹³å°è®¸å¯è¯...");
        var token = window.djiBridge.platformVerifyLicense(
          APP_ID,
          APP_KEY,
          LICENSE
        );
        log("å¹³å°éªŒè¯çŠ¶æ€ï¼š" + window.djiBridge.platformIsVerified());

        var register_params = JSON.stringify({
          host: MQTT_HOST, // MQTT åœ°å€ï¼Œä¾‹å¦‚ï¼štcp://xx.xx.xx.xx:xxx
          connectCallback: "reg_calback", // ç”¨äºæ¥æ”¶è¿æ¥çŠ¶æ€å›è°ƒçš„ JS æ¥å£
          username: MQTT_USERNAME,
          password: MQTT_PASSWORD,
        });
        
        log(
          "åŠ è½½ç»„ä»¶ thingï¼š" +
            window.djiBridge.platformLoadComponent("thing", register_params) +
            "\\nå½“å‰çŠ¶æ€â„¹ï¸ï¼š" +
            window.djiBridge.thingGetConnectState()
        );
        log(
          "å¼€å§‹è¿æ¥ thingconnï¼š" +
            window.djiBridge.thingConnect(MQTT_USERNAME, MQTT_PASSWORD, "reg_calback")
        );

        log("Thing è¿æ¥çŠ¶æ€ï¼š" + window.djiBridge.thingGetConnectState());
        // åœ¨æ­¤å¤„å¡«å†™ç™»å½•ä¿¡æ¯ã€å¯†ç ã€ç½‘å…³ç­‰ã€‚
      });

      var logoutButton = document.getElementById("logout-button");
      logoutButton.addEventListener("click", function () {
        log(
          "å¸è½½ç»„ä»¶ï¼š" + window.djiBridge.platformUnloadComponent("thing")
        );
      });

      document
        .getElementById("raport-button")
        .addEventListener("click", function () {
          log(
            "ç»„ä»¶åŠ è½½çŠ¶æ€ï¼š" +
              window.djiBridge.platformIsComponentLoaded("thing") +
              "\\nthing çŠ¶æ€ï¼š" +
              window.djiBridge.thingGetConnectState()
          );
        });

      log("é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œå¹³å°éªŒè¯çŠ¶æ€ï¼š" + window.djiBridge.platformIsVerified());
    </script>
  </body>
</html>